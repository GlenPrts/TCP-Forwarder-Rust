name: Dependency Updates

on:
  schedule:
    # æ¯å‘¨ä¸€ UTC 08:00 è¿è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-rust-dependencies:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Update dependencies
        run: |
          cd tcp-forwarder
          cargo upgrade
          cargo update

      - name: Run tests
        run: |
          cd tcp-forwarder
          cargo test

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Rust dependencies'
          title: 'ğŸ”„ Update Rust Dependencies'
          body: |
            ## ğŸ“¦ ä¾èµ–é¡¹æ›´æ–°
            
            This PR updates Rust dependencies to their latest versions.
            
            ### ğŸ” Changes
            - Updated Cargo dependencies
            - Ran `cargo upgrade` and `cargo update`
            - Verified all tests pass
            
            ### ğŸ§ª Testing
            - [x] All existing tests pass
            - [x] No breaking changes detected
            
            This PR was automatically created by the dependency update workflow.
          branch: update-dependencies
          delete-branch: true
          base: main

  update-docker-base-image:
    name: Check Docker Base Image Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for updates
        id: check
        run: |
          # è·å–å½“å‰Dockerfileä¸­çš„åŸºç¡€é•œåƒç‰ˆæœ¬
          current_rust=$(grep "FROM rust:" Dockerfile | head -1 | cut -d: -f2 | cut -d- -f1)
          current_debian=$(grep "FROM debian:" Dockerfile | tail -1 | cut -d: -f2)
          
          echo "current_rust=$current_rust" >> $GITHUB_OUTPUT
          echo "current_debian=$current_debian" >> $GITHUB_OUTPUT
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€»è¾‘æ¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
          echo "checking for updates..."

      - name: Create issue for manual review
        if: steps.check.outputs.current_rust != ''
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ³ DockeråŸºç¡€é•œåƒæ£€æŸ¥';
            const body = `## DockeråŸºç¡€é•œåƒçŠ¶æ€æ£€æŸ¥
            
            å½“å‰ä½¿ç”¨çš„åŸºç¡€é•œåƒï¼š
            - Rust: \`${{ steps.check.outputs.current_rust }}\`
            - Debian: \`${{ steps.check.outputs.current_debian }}\`
            
            è¯·æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å¯ç”¨å¹¶è€ƒè™‘æ›´æ–°ã€‚
            
            ### æ£€æŸ¥æ¸…å•
            - [ ] æ£€æŸ¥ [Rustå®˜æ–¹é•œåƒ](https://hub.docker.com/_/rust) æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            - [ ] æ£€æŸ¥ [Debianå®˜æ–¹é•œåƒ](https://hub.docker.com/_/debian) æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            - [ ] æµ‹è¯•æ–°é•œåƒçš„å…¼å®¹æ€§
            - [ ] æ›´æ–°Dockerfile
            
            æ­¤issueç”±ä¾èµ–æ›´æ–°å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'docker,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('DockeråŸºç¡€é•œåƒæ£€æŸ¥')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['docker', 'dependencies', 'maintenance']
              });
            }

  update-github-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update GitHub Actions versions
        uses: mheap/github-action-auto-update@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'
          title: 'ğŸ”„ Update GitHub Actions'
          body: |
            ## ğŸ”§ GitHub Actions æ›´æ–°
            
            This PR updates GitHub Actions to their latest versions.
            
            ### ğŸ” Changes
            - Updated action versions in workflow files
            - Ensured compatibility with latest features
            
            ### ğŸ§ª Testing
            This change will be tested when the PR is merged.
            
            This PR was automatically created by the dependency update workflow.
          branch: update-github-actions
          delete-branch: true
          base: main
