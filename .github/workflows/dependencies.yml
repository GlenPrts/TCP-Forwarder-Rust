# Dependency Updates
#
# 本工作流自动化依赖项更新，包括 Rust 依赖、Docker基础镜像、GitHub Actions。
# 支持手动触发和定时触发（可解注释 schedule）。

name: Dependency Updates

on:
  # schedule:
  #   - cron: '0 8 * * 1' # 每周一 UTC 08:00 运行
  workflow_dispatch:

jobs:
  # 1. Rust 依赖自动更新
  update-rust-dependencies:
    name: Rust 依赖自动更新
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置 Rust 工具链
        uses: dtolnay/rust-toolchain@stable

      - name: 安装 cargo-edit
        run: cargo install cargo-edit

      - name: 升级依赖
        run: |
          cd tcp-forwarder
          cargo upgrade
          cargo update

      - name: 运行测试
        run: |
          cd tcp-forwarder
          cargo test

      - name: 创建依赖更新 PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Rust dependencies'
          title: '🔄 Update Rust Dependencies'
          body: |
            ## 📦 依赖项更新
            
            本 PR 自动更新 Rust 依赖到最新版本。
            
            ### 🔍 变更内容
            - 更新 Cargo 依赖
            - 执行 `cargo upgrade` 和 `cargo update`
            - 验证所有测试通过
            
            ### 🧪 测试
            - [x] 所有现有测试通过
            - [x] 未检测到破坏性变更
            
            本 PR 由依赖更新工作流自动创建。
          branch: update-dependencies
          delete-branch: true
          base: main

  # 2. 检查 Docker 基础镜像更新
  update-docker-base-image:
    name: 检查 Docker 基础镜像更新
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 检查基础镜像版本
        id: check
        run: |
          current_rust=$(grep "FROM rust:" Dockerfile | head -1 | cut -d: -f2 | cut -d- -f1)
          current_debian=$(grep "FROM debian:" Dockerfile | tail -1 | cut -d: -f2)
          echo "current_rust=$current_rust" >> $GITHUB_OUTPUT
          echo "current_debian=$current_debian" >> $GITHUB_OUTPUT
          echo "checking for updates..."

      - name: 创建手动检查 Issue
        if: steps.check.outputs.current_rust != ''
        uses: actions/github-script@v7
        with:
          script: |
            const title = '🐳 Docker基础镜像检查';
            const body = `## Docker基础镜像状态检查
            
            当前使用的基础镜像：
            - Rust: \`${{ steps.check.outputs.current_rust }}\`
            - Debian: \`${{ steps.check.outputs.current_debian }}\`
            
            请手动检查是否有新版本可用并考虑更新。
            
            ### 检查清单
            - [ ] 检查 [Rust官方镜像](https://hub.docker.com/_/rust) 是否有新版本
            - [ ] 检查 [Debian官方镜像](https://hub.docker.com/_/debian) 是否有新版本
            - [ ] 测试新镜像的兼容性
            - [ ] 更新Dockerfile
            
            此issue由依赖更新工作流自动创建。`;
            // 检查是否已存在类似的issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'docker,dependencies'
            });
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Docker基础镜像检查')
            );
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['docker', 'dependencies', 'maintenance']
              });
            }

  # 3. GitHub Actions 自动更新
  update-github-actions:
    name: GitHub Actions 自动更新
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 自动更新 Actions 版本
        uses: mheap/github-action-auto-update@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'

      - name: 创建 Actions 更新 PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'
          title: '🔄 Update GitHub Actions'
          body: |
            ## 🔧 GitHub Actions 更新
            
            本 PR 自动更新工作流文件中的 Actions 版本。
            
            ### 🔍 变更内容
            - 更新 workflow 文件中的 action 版本
            - 确保兼容最新功能
            
            ### 🧪 测试
            合并后将自动测试。
            
            本 PR 由依赖更新工作流自动创建。
          branch: update-github-actions
          delete-branch: true
          base: main
