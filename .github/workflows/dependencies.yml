# Dependency Updates
#
# æœ¬å·¥ä½œæµè‡ªåŠ¨åŒ–ä¾èµ–é¡¹æ›´æ–°ï¼ŒåŒ…æ‹¬ Rust ä¾èµ–ã€DockeråŸºç¡€é•œåƒã€GitHub Actionsã€‚
# æ”¯æŒæ‰‹åŠ¨è§¦å‘å’Œå®šæ—¶è§¦å‘ï¼ˆå¯è§£æ³¨é‡Š scheduleï¼‰ã€‚

name: Dependency Updates

on:
  # schedule:
  #   - cron: '0 8 * * 1' # æ¯å‘¨ä¸€ UTC 08:00 è¿è¡Œ
  workflow_dispatch:

jobs:
  # 1. Rust ä¾èµ–è‡ªåŠ¨æ›´æ–°
  update-rust-dependencies:
    name: Rust ä¾èµ–è‡ªåŠ¨æ›´æ–°
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£… cargo-edit
        run: cargo install cargo-edit

      - name: å‡çº§ä¾èµ–
        run: |
          cd tcp-forwarder
          cargo upgrade
          cargo update

      - name: è¿è¡Œæµ‹è¯•
        run: |
          cd tcp-forwarder
          cargo test

      - name: åˆ›å»ºä¾èµ–æ›´æ–° PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Rust dependencies'
          title: 'ğŸ”„ Update Rust Dependencies'
          body: |
            ## ğŸ“¦ ä¾èµ–é¡¹æ›´æ–°
            
            æœ¬ PR è‡ªåŠ¨æ›´æ–° Rust ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚
            
            ### ğŸ” å˜æ›´å†…å®¹
            - æ›´æ–° Cargo ä¾èµ–
            - æ‰§è¡Œ `cargo upgrade` å’Œ `cargo update`
            - éªŒè¯æ‰€æœ‰æµ‹è¯•é€šè¿‡
            
            ### ğŸ§ª æµ‹è¯•
            - [x] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
            - [x] æœªæ£€æµ‹åˆ°ç ´åæ€§å˜æ›´
            
            æœ¬ PR ç”±ä¾èµ–æ›´æ–°å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚
          branch: update-dependencies
          delete-branch: true
          base: main

  # 2. æ£€æŸ¥ Docker åŸºç¡€é•œåƒæ›´æ–°
  update-docker-base-image:
    name: æ£€æŸ¥ Docker åŸºç¡€é•œåƒæ›´æ–°
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥åŸºç¡€é•œåƒç‰ˆæœ¬
        id: check
        run: |
          current_rust=$(grep "FROM rust:" Dockerfile | head -1 | cut -d: -f2 | cut -d- -f1)
          current_debian=$(grep "FROM debian:" Dockerfile | tail -1 | cut -d: -f2)
          echo "current_rust=$current_rust" >> $GITHUB_OUTPUT
          echo "current_debian=$current_debian" >> $GITHUB_OUTPUT
          echo "checking for updates..."

      - name: åˆ›å»ºæ‰‹åŠ¨æ£€æŸ¥ Issue
        if: steps.check.outputs.current_rust != ''
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ³ DockeråŸºç¡€é•œåƒæ£€æŸ¥';
            const body = `## DockeråŸºç¡€é•œåƒçŠ¶æ€æ£€æŸ¥
            
            å½“å‰ä½¿ç”¨çš„åŸºç¡€é•œåƒï¼š
            - Rust: \`${{ steps.check.outputs.current_rust }}\`
            - Debian: \`${{ steps.check.outputs.current_debian }}\`
            
            è¯·æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å¯ç”¨å¹¶è€ƒè™‘æ›´æ–°ã€‚
            
            ### æ£€æŸ¥æ¸…å•
            - [ ] æ£€æŸ¥ [Rustå®˜æ–¹é•œåƒ](https://hub.docker.com/_/rust) æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            - [ ] æ£€æŸ¥ [Debianå®˜æ–¹é•œåƒ](https://hub.docker.com/_/debian) æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            - [ ] æµ‹è¯•æ–°é•œåƒçš„å…¼å®¹æ€§
            - [ ] æ›´æ–°Dockerfile
            
            æ­¤issueç”±ä¾èµ–æ›´æ–°å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚`;
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'docker,dependencies'
            });
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('DockeråŸºç¡€é•œåƒæ£€æŸ¥')
            );
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['docker', 'dependencies', 'maintenance']
              });
            }

  # 3. GitHub Actions è‡ªåŠ¨æ›´æ–°
  update-github-actions:
    name: GitHub Actions è‡ªåŠ¨æ›´æ–°
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è‡ªåŠ¨æ›´æ–° Actions ç‰ˆæœ¬
        uses: mheap/github-action-auto-update@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'

      - name: åˆ›å»º Actions æ›´æ–° PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'
          title: 'ğŸ”„ Update GitHub Actions'
          body: |
            ## ğŸ”§ GitHub Actions æ›´æ–°
            
            æœ¬ PR è‡ªåŠ¨æ›´æ–°å·¥ä½œæµæ–‡ä»¶ä¸­çš„ Actions ç‰ˆæœ¬ã€‚
            
            ### ğŸ” å˜æ›´å†…å®¹
            - æ›´æ–° workflow æ–‡ä»¶ä¸­çš„ action ç‰ˆæœ¬
            - ç¡®ä¿å…¼å®¹æœ€æ–°åŠŸèƒ½
            
            ### ğŸ§ª æµ‹è¯•
            åˆå¹¶åå°†è‡ªåŠ¨æµ‹è¯•ã€‚
            
            æœ¬ PR ç”±ä¾èµ–æ›´æ–°å·¥ä½œæµè‡ªåŠ¨åˆ›å»ºã€‚
          branch: update-github-actions
          delete-branch: true
          base: main
