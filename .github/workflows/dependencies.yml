name: Dependency Updates

on:
  schedule:
    # 每周一 UTC 08:00 运行
    - cron: '0 8 * * 1'
  workflow_dispatch: # 允许手动触发

jobs:
  update-rust-dependencies:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Update dependencies
        run: |
          cd tcp-forwarder
          cargo upgrade
          cargo update

      - name: Run tests
        run: |
          cd tcp-forwarder
          cargo test

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update Rust dependencies'
          title: '🔄 Update Rust Dependencies'
          body: |
            ## 📦 依赖项更新
            
            This PR updates Rust dependencies to their latest versions.
            
            ### 🔍 Changes
            - Updated Cargo dependencies
            - Ran `cargo upgrade` and `cargo update`
            - Verified all tests pass
            
            ### 🧪 Testing
            - [x] All existing tests pass
            - [x] No breaking changes detected
            
            This PR was automatically created by the dependency update workflow.
          branch: update-dependencies
          delete-branch: true
          base: main

  update-docker-base-image:
    name: Check Docker Base Image Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for updates
        id: check
        run: |
          # 获取当前Dockerfile中的基础镜像版本
          current_rust=$(grep "FROM rust:" Dockerfile | head -1 | cut -d: -f2 | cut -d- -f1)
          current_debian=$(grep "FROM debian:" Dockerfile | tail -1 | cut -d: -f2)
          
          echo "current_rust=$current_rust" >> $GITHUB_OUTPUT
          echo "current_debian=$current_debian" >> $GITHUB_OUTPUT
          
          # 这里可以添加逻辑来检查是否有新版本
          echo "checking for updates..."

      - name: Create issue for manual review
        if: steps.check.outputs.current_rust != ''
        uses: actions/github-script@v7
        with:
          script: |
            const title = '🐳 Docker基础镜像检查';
            const body = `## Docker基础镜像状态检查
            
            当前使用的基础镜像：
            - Rust: \`${{ steps.check.outputs.current_rust }}\`
            - Debian: \`${{ steps.check.outputs.current_debian }}\`
            
            请手动检查是否有新版本可用并考虑更新。
            
            ### 检查清单
            - [ ] 检查 [Rust官方镜像](https://hub.docker.com/_/rust) 是否有新版本
            - [ ] 检查 [Debian官方镜像](https://hub.docker.com/_/debian) 是否有新版本
            - [ ] 测试新镜像的兼容性
            - [ ] 更新Dockerfile
            
            此issue由依赖更新工作流自动创建。`;
            
            // 检查是否已存在类似的issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'docker,dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Docker基础镜像检查')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['docker', 'dependencies', 'maintenance']
              });
            }

  update-github-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update GitHub Actions versions
        uses: mheap/github-action-auto-update@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update GitHub Actions versions'
          title: '🔄 Update GitHub Actions'
          body: |
            ## 🔧 GitHub Actions 更新
            
            This PR updates GitHub Actions to their latest versions.
            
            ### 🔍 Changes
            - Updated action versions in workflow files
            - Ensured compatibility with latest features
            
            ### 🧪 Testing
            This change will be tested when the PR is merged.
            
            This PR was automatically created by the dependency update workflow.
          branch: update-github-actions
          delete-branch: true
          base: main
