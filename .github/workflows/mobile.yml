name: Mobile Platforms Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tcp-forwarder/**'
      - '.github/workflows/mobile.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'tcp-forwarder/**'
      - '.github/workflows/mobile.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    name: Build for Android (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64-linux-android
          - armv7-linux-androideabi
          - i686-linux-android
          - x86_64-linux-android
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: android-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Configure Android environment
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          
          case "${{ matrix.target }}" in
            aarch64-linux-android)
              echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
              echo "CC_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
              echo "CXX_aarch64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++" >> $GITHUB_ENV
              ;;
            armv7-linux-androideabi)
              echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
              echo "CC_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang" >> $GITHUB_ENV
              echo "CXX_armv7_linux_androideabi=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++" >> $GITHUB_ENV
              ;;
            i686-linux-android)
              echo "CARGO_TARGET_I686_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang" >> $GITHUB_ENV
              echo "CC_i686_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang" >> $GITHUB_ENV
              echo "CXX_i686_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang++" >> $GITHUB_ENV
              ;;
            x86_64-linux-android)
              echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang" >> $GITHUB_ENV
              echo "CC_x86_64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang" >> $GITHUB_ENV
              echo "CXX_x86_64_linux_android=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang++" >> $GITHUB_ENV
              ;;
          esac

      - name: Build for Android
        run: |
          cd tcp-forwarder
          cargo build --release --target ${{ matrix.target }}

      - name: Verify build
        run: |
          ls -la tcp-forwarder/target/${{ matrix.target }}/release/
          file tcp-forwarder/target/${{ matrix.target }}/release/tcp-forwarder

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tcp-forwarder-android-${{ matrix.target }}
          path: tcp-forwarder/target/${{ matrix.target }}/release/tcp-forwarder

  build-ios:
    name: Build for iOS (${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - aarch64-apple-ios      # iPhone (ARM64)
          - x86_64-apple-ios       # iOS Simulator (Intel)
          - aarch64-apple-ios-sim  # iOS Simulator (Apple Silicon)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: ios-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install iOS development tools
        run: |
          # ç¡®ä¿å®‰è£…äº† Xcode å‘½ä»¤è¡Œå·¥å…·
          xcode-select --install 2>/dev/null || true
          
          # æ˜¾ç¤ºå¯ç”¨çš„ iOS SDK
          xcrun --show-sdk-path --sdk iphoneos
          xcrun --show-sdk-path --sdk iphonesimulator

      - name: Build for iOS
        run: |
          cd tcp-forwarder
          
          # è®¾ç½® iOS SDK è·¯å¾„
          case "${{ matrix.target }}" in
            aarch64-apple-ios)
              export IPHONEOS_DEPLOYMENT_TARGET=12.0
              ;;
            x86_64-apple-ios|aarch64-apple-ios-sim)
              export IPHONEOS_DEPLOYMENT_TARGET=12.0
              ;;
          esac
          
          cargo build --release --target ${{ matrix.target }}

      - name: Verify build
        run: |
          ls -la tcp-forwarder/target/${{ matrix.target }}/release/
          file tcp-forwarder/target/${{ matrix.target }}/release/tcp-forwarder

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tcp-forwarder-ios-${{ matrix.target }}
          path: tcp-forwarder/target/${{ matrix.target }}/release/tcp-forwarder

  create-mobile-package:
    name: Create Mobile Package
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all mobile artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tcp-forwarder-*
          path: mobile-binaries

      - name: Create mobile package structure
        run: |
          mkdir -p mobile-package/{android,ios,docs}
          
          # ç»„ç»‡ Android äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -d "mobile-binaries" ]; then
            find mobile-binaries -name "*android*" -type d | while read dir; do
              target=$(basename "$dir" | sed 's/tcp-forwarder-android-//')
              if [ -f "$dir/tcp-forwarder" ]; then
                cp "$dir/tcp-forwarder" "mobile-package/android/tcp-forwarder-$target"
              fi
            done
            
            # ç»„ç»‡ iOS äºŒè¿›åˆ¶æ–‡ä»¶
            find mobile-binaries -name "*ios*" -type d | while read dir; do
              target=$(basename "$dir" | sed 's/tcp-forwarder-ios-//')
              if [ -f "$dir/tcp-forwarder" ]; then
                cp "$dir/tcp-forwarder" "mobile-package/ios/tcp-forwarder-$target"
              fi
            done
          fi

      - name: Create mobile documentation
        run: |
          cat > mobile-package/README.md << 'EOF'
          # TCP Forwarder - ç§»åŠ¨å¹³å°æž„å»º

          ## ðŸ“± æ”¯æŒçš„å¹³å°

          ### Android
          - `aarch64-linux-android` - ARM64 è®¾å¤‡ (å¤§å¤šæ•°çŽ°ä»£ Android è®¾å¤‡)
          - `armv7-linux-androideabi` - ARMv7 è®¾å¤‡ (è¾ƒè€çš„ Android è®¾å¤‡)
          - `i686-linux-android` - x86 è®¾å¤‡ (æ¨¡æ‹Ÿå™¨å’Œä¸€äº›å¹³æ¿)
          - `x86_64-linux-android` - x86_64 è®¾å¤‡ (æ¨¡æ‹Ÿå™¨å’Œä¸€äº›è®¾å¤‡)

          ### iOS
          - `aarch64-apple-ios` - iPhone/iPad (ARM64)
          - `x86_64-apple-ios` - iOS æ¨¡æ‹Ÿå™¨ (Intel Mac)
          - `aarch64-apple-ios-sim` - iOS æ¨¡æ‹Ÿå™¨ (Apple Silicon Mac)

          ## ðŸš€ ä½¿ç”¨è¯´æ˜Ž

          ### Android éƒ¨ç½²
          1. é€‰æ‹©é€‚åˆæ‚¨è®¾å¤‡æž¶æž„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. é€šè¿‡ ADB æŽ¨é€åˆ°è®¾å¤‡ï¼š
             ```bash
             adb push tcp-forwarder-aarch64-linux-android /data/local/tmp/tcp-forwarder
             adb shell chmod +x /data/local/tmp/tcp-forwarder
             ```
          3. åˆ›å»ºé…ç½®æ–‡ä»¶å¹¶è¿è¡Œ

          ### iOS éƒ¨ç½²
          1. è¿™äº›æ˜¯é™æ€åº“æ–‡ä»¶ï¼Œéœ€è¦é›†æˆåˆ° iOS åº”ç”¨ä¸­
          2. æˆ–è€…åœ¨è¶Šç‹±è®¾å¤‡ä¸Šç›´æŽ¥è¿è¡Œ

          ## âš ï¸ æ³¨æ„äº‹é¡¹

          ### Android
          - éœ€è¦ç½‘ç»œæƒé™
          - æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦ root æƒé™
          - å»ºè®®åœ¨ API çº§åˆ« 21+ ä¸Šè¿è¡Œ

          ### iOS
          - éœ€è¦åœ¨è¶Šç‹±è®¾å¤‡ä¸Šè¿è¡Œï¼Œæˆ–é›†æˆåˆ°åº”ç”¨ä¸­
          - éœ€è¦ç½‘ç»œæƒé™å£°æ˜Ž
          - éµå¾ª App Store æ”¿ç­–ï¼ˆå¦‚æžœå‘å¸ƒåº”ç”¨ï¼‰

          ## ðŸ”§ é…ç½®

          ç§»åŠ¨å¹³å°çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¸Žæ¡Œé¢ç‰ˆæœ¬ç›¸åŒï¼Œä½†è¯·æ³¨æ„ï¼š
          - æ–‡ä»¶è·¯å¾„éœ€è¦é€‚é…ç§»åŠ¨å¹³å°
          - ç«¯å£ç»‘å®šå¯èƒ½å—åˆ°ç³»ç»Ÿé™åˆ¶
          - æŸäº›é«˜ç«¯å£éœ€è¦ç‰¹æ®Šæƒé™
          EOF

          cat > mobile-package/docs/android-integration.md << 'EOF'
          # Android é›†æˆæŒ‡å—

          ## ðŸ› ï¸ é›†æˆæ–¹å¼

          ### 1. ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶
          ```bash
          # æŽ¨é€åˆ°è®¾å¤‡
          adb push tcp-forwarder-aarch64-linux-android /data/local/tmp/tcp-forwarder
          adb shell chmod +x /data/local/tmp/tcp-forwarder

          # è¿è¡Œ
          adb shell '/data/local/tmp/tcp-forwarder --config /sdcard/config.yaml'
          ```

          ### 2. Android åº”ç”¨é›†æˆ
          ä½¿ç”¨ JNI å°† Rust ä»£ç é›†æˆåˆ° Android åº”ç”¨ä¸­ï¼š

          #### build.gradle é…ç½®
          ```gradle
          android {
              defaultConfig {
                  ndk {
                      abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64'
                  }
              }
          }
          ```

          #### æƒé™å£°æ˜Ž (AndroidManifest.xml)
          ```xml
          <uses-permission android:name="android.permission.INTERNET" />
          <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
          <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
          ```

          ## ðŸ“± è®¾å¤‡å…¼å®¹æ€§

          | æž¶æž„ | è®¾å¤‡ç¤ºä¾‹ |
          |------|----------|
          | arm64-v8a | å¤§å¤šæ•°çŽ°ä»£ Android è®¾å¤‡ |
          | armeabi-v7a | è¾ƒè€çš„ Android è®¾å¤‡ |
          | x86 | Android æ¨¡æ‹Ÿå™¨ï¼Œéƒ¨åˆ†å¹³æ¿ |
          | x86_64 | Android æ¨¡æ‹Ÿå™¨ï¼Œéƒ¨åˆ†è®¾å¤‡ |

          ## ðŸ”§ é…ç½®æ³¨æ„äº‹é¡¹

          - é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`/sdcard/tcp-forwarder/config.yaml`
          - æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼š`/sdcard/tcp-forwarder/logs/`
          - ç»‘å®šç«¯å£ï¼šé¿å…ä½¿ç”¨ç³»ç»Ÿä¿ç•™ç«¯å£ (1-1024)
          EOF

          cat > mobile-package/docs/ios-integration.md << 'EOF'
          # iOS é›†æˆæŒ‡å—

          ## ðŸ› ï¸ é›†æˆæ–¹å¼

          ### 1. è¶Šç‹±è®¾å¤‡ä½¿ç”¨
          ```bash
          # é€šè¿‡ SSH æˆ–æ–‡ä»¶ç®¡ç†å™¨ä¸Šä¼ 
          scp tcp-forwarder-aarch64-apple-ios root@device:/usr/local/bin/tcp-forwarder
          ssh root@device 'chmod +x /usr/local/bin/tcp-forwarder'

          # è¿è¡Œ
          ssh root@device '/usr/local/bin/tcp-forwarder --config /var/mobile/config.yaml'
          ```

          ### 2. iOS åº”ç”¨é›†æˆ
          åˆ›å»º C ç»‘å®šä»¥åœ¨ iOS åº”ç”¨ä¸­ä½¿ç”¨ï¼š

          #### Info.plist æƒé™
          ```xml
          <key>NSAppTransportSecurity</key>
          <dict>
              <key>NSAllowsArbitraryLoads</key>
              <true/>
          </dict>
          ```

          #### Swift é›†æˆç¤ºä¾‹
          ```swift
          import Foundation

          class TCPForwarder {
              func start(configPath: String) {
                  // è°ƒç”¨ Rust å‡½æ•°
              }
          }
          ```

          ## ðŸ“± è®¾å¤‡å…¼å®¹æ€§

          | ç›®æ ‡ | ç”¨é€” |
          |------|------|
          | aarch64-apple-ios | çœŸå®žè®¾å¤‡ (iPhone/iPad) |
          | x86_64-apple-ios | æ¨¡æ‹Ÿå™¨ (Intel Mac) |
          | aarch64-apple-ios-sim | æ¨¡æ‹Ÿå™¨ (Apple Silicon Mac) |

          ## ðŸ”§ é…ç½®æ³¨æ„äº‹é¡¹

          - é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`Documents/tcp-forwarder/config.yaml`
          - æ²™ç›’é™åˆ¶ï¼šåªèƒ½è®¿é—®åº”ç”¨æ²™ç›’å†…çš„æ–‡ä»¶
          - ç½‘ç»œæƒé™ï¼šéœ€è¦åœ¨ Info.plist ä¸­å£°æ˜Ž
          - åŽå°è¿è¡Œï¼šå¯èƒ½å—åˆ° iOS åŽå°é™åˆ¶
          EOF

          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > mobile-package/BUILD_INFO.txt << EOF
          æž„å»ºæ—¶é—´: $(date)
          Git æäº¤: ${GITHUB_SHA:-"unknown"}
          æž„å»ºåˆ†æ”¯: ${GITHUB_REF_NAME:-"unknown"}
          
          Android ç›®æ ‡:
          - aarch64-linux-android
          - armv7-linux-androideabi
          - i686-linux-android
          - x86_64-linux-android
          
          iOS ç›®æ ‡:
          - aarch64-apple-ios
          - x86_64-apple-ios
          - aarch64-apple-ios-sim
          EOF

      - name: Package mobile binaries
        run: |
          tar -czf tcp-forwarder-mobile-platforms.tar.gz mobile-package/

      - name: Upload mobile package
        uses: actions/upload-artifact@v4
        with:
          name: tcp-forwarder-mobile-package
          path: |
            tcp-forwarder-mobile-platforms.tar.gz
            mobile-package/

  test-mobile-builds:
    name: Test Mobile Builds
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: tcp-forwarder-android-*
          path: android-test

      - name: Test Android binaries
        run: |
          echo "=== Android æž„å»ºæµ‹è¯• ==="
          for dir in android-test/tcp-forwarder-android-*; do
            if [ -d "$dir" ]; then
              target=$(basename "$dir" | sed 's/tcp-forwarder-android-//')
              echo "æµ‹è¯• Android $target æž„å»º:"
              if [ -f "$dir/tcp-forwarder" ]; then
                echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨"
                echo "æ–‡ä»¶å¤§å°: $(du -h "$dir/tcp-forwarder" | cut -f1)"
                echo "æ–‡ä»¶ç±»åž‹: $(file "$dir/tcp-forwarder")"
              else
                echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
              fi
              echo "---"
            fi
          done

      - name: Download iOS artifacts  
        uses: actions/download-artifact@v4
        with:
          pattern: tcp-forwarder-ios-*
          path: ios-test

      - name: Test iOS binaries
        run: |
          echo "=== iOS æž„å»ºæµ‹è¯• ==="
          for dir in ios-test/tcp-forwarder-ios-*; do
            if [ -d "$dir" ]; then
              target=$(basename "$dir" | sed 's/tcp-forwarder-ios-//')
              echo "æµ‹è¯• iOS $target æž„å»º:"
              if [ -f "$dir/tcp-forwarder" ]; then
                echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨"
                echo "æ–‡ä»¶å¤§å°: $(du -h "$dir/tcp-forwarder" | cut -f1)"
                echo "æ–‡ä»¶ç±»åž‹: $(file "$dir/tcp-forwarder")"
              else
                echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
              fi
              echo "---"
            fi
          done
