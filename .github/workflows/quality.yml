name: Code Quality & Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤© UTC 02:00 è¿è¡Œå…¨é¢æ‰«æ
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Format check
        run: |
          cd tcp-forwarder
          cargo fmt --all -- --check

      - name: Clippy analysis
        run: |
          cd tcp-forwarder
          cargo clippy --all-targets --all-features -- -D warnings

      - name: Documentation check
        run: |
          cd tcp-forwarder
          cargo doc --no-deps --document-private-items

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: |
          cd tcp-forwarder
          cargo audit

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Run cargo-deny
        run: |
          cd tcp-forwarder
          cargo deny check

  vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'cpp'  # Rustç¼–è¯‘åçš„ä»£ç 
          queries: security-and-quality

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build project
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license

      - name: Check licenses
        run: |
          cd tcp-forwarder
          cargo license --json > licenses.json
          
      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: tcp-forwarder/licenses.json

  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install criterion
        run: |
          cd tcp-forwarder
          # å¦‚æœæœ‰æ€§èƒ½æµ‹è¯•ï¼Œæ·»åŠ criterionä¾èµ–
          # cargo add --dev criterion

      - name: Run benchmarks
        run: |
          cd tcp-forwarder
          # cargo bench
          echo "æ€§èƒ½æµ‹è¯•é…ç½®å¾…å®Œå–„"

  supply-chain-security:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SLSA Generic Generator
        id: generator
        uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.10.0
        with:
          base64-subjects: ""
          provenance-name: "tcp-forwarder-provenance.intoto.jsonl"

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [code-quality, security-audit, vulnerability-scan]
    if: always()
    steps:
      - name: Check quality gate
        run: |
          echo "=== è´¨é‡é—¨ç¦æ£€æŸ¥ ==="
          
          # æ£€æŸ¥å„ä¸ªjobçš„çŠ¶æ€
          code_quality="${{ needs.code-quality.result }}"
          security_audit="${{ needs.security-audit.result }}"
          vulnerability_scan="${{ needs.vulnerability-scan.result }}"
          
          echo "ä»£ç è´¨é‡æ£€æŸ¥: $code_quality"
          echo "å®‰å…¨å®¡è®¡: $security_audit"
          echo "æ¼æ´æ‰«æ: $vulnerability_scan"
          
          # å¦‚æœä»»ä½•å…³é”®æ£€æŸ¥å¤±è´¥ï¼Œåˆ™å¤±è´¥
          if [[ "$code_quality" != "success" || "$security_audit" != "success" ]]; then
            echo "âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          
          if [[ "$vulnerability_scan" != "success" ]]; then
            echo "âš ï¸  æ¼æ´æ‰«ææ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹å®‰å…¨æŠ¥å‘Š"
            # å¯ä»¥é€‰æ‹©æ˜¯å¦å› ä¸ºæ¼æ´æ‰«æå¤±è´¥è€Œé˜»æ­¢éƒ¨ç½²
            # exit 1
          fi
          
          echo "âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡"

      - name: Comment PR on failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ è´¨é‡é—¨ç¦æ£€æŸ¥å¤±è´¥
              
              ä»£ç è´¨é‡æˆ–å®‰å…¨æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
              
              - ğŸ” ä»£ç æ ¼å¼å’ŒClippyè­¦å‘Š
              - ğŸ”’ å®‰å…¨æ¼æ´å’Œä¾èµ–é¡¹å®¡è®¡
              - ğŸ“‹ è®¸å¯è¯åˆè§„æ€§
              
              è¯·ä¿®å¤ç›¸å…³é—®é¢˜åé‡æ–°æäº¤ã€‚`
            })

      - name: Comment PR on success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… è´¨é‡é—¨ç¦æ£€æŸ¥é€šè¿‡
              
              æ‰€æœ‰ä»£ç è´¨é‡å’Œå®‰å…¨æ£€æŸ¥å‡å·²é€šè¿‡ï¼
              
              - âœ… ä»£ç æ ¼å¼è§„èŒƒ
              - âœ… æ— Clippyè­¦å‘Š
              - âœ… æ— å·²çŸ¥å®‰å…¨æ¼æ´
              - âœ… ä¾èµ–é¡¹å®¡è®¡é€šè¿‡
              
              è¯¥PRå¯ä»¥å®‰å…¨åˆå¹¶ã€‚`
            })
