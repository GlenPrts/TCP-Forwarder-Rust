name: Performance Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤© UTC 06:00 è¿è¡Œæ€§èƒ½ç›‘æŽ§
    - cron: '0 6 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Run unit test benchmarks
        run: |
          cd tcp-forwarder
          # è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          cargo test --release --tests -- --nocapture

      - name: Memory usage analysis
        run: |
          cd tcp-forwarder
          # ç¼–è¯‘ç”¨äºŽå†…å­˜åˆ†æžçš„ç‰ˆæœ¬
          cargo build --release
          
          # ä½¿ç”¨valgrindè¿›è¡Œå†…å­˜åˆ†æžï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if command -v valgrind &> /dev/null; then
            echo "Running memory analysis..."
            # valgrind --tool=massif --detailed-freq=1 --max-snapshots=100 ./target/release/tcp-forwarder --help
          fi

      - name: Binary size analysis
        run: |
          cd tcp-forwarder
          cargo build --release
          
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°åˆ†æž ==="
          ls -lh target/release/tcp-forwarder
          
          # ä½¿ç”¨stripå‡å°äºŒè¿›åˆ¶å¤§å°
          strip target/release/tcp-forwarder
          echo "After strip:"
          ls -lh target/release/tcp-forwarder
          
          # åˆ†æžäºŒè¿›åˆ¶æ–‡ä»¶ç»„æˆ
          if command -v bloaty &> /dev/null; then
            bloaty target/release/tcp-forwarder
          fi

  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build application
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Setup test environment
        run: |
          # å®‰è£…è´Ÿè½½æµ‹è¯•å·¥å…·
          sudo apt-get update
          sudo apt-get install -y wrk apache2-utils

      - name: Start TCP forwarder
        run: |
          cd tcp-forwarder
          # åˆ›å»ºæµ‹è¯•é…ç½®
          cat > test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: true
              health_check_interval: 10s
              max_retries: 3
              weight: 1.0
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3000"
            
          metrics:
            enabled: true
            bind: "127.0.0.1:9090"
            
          scoring:
            algorithm: "ewma"
            ewma:
              alpha: 0.1
              max_score: 1000.0
              min_score: 1.0
              window_size: 10
          EOF
          
          # å¯åŠ¨åº”ç”¨ç¨‹åºï¼ˆåŽå°è¿è¡Œï¼‰
          ./target/release/tcp-forwarder --config test_config.yaml &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 5

      - name: Setup mock backend
        run: |
          # åˆ›å»ºç®€å•çš„HTTPæœåŠ¡å™¨ä½œä¸ºåŽç«¯
          python3 -m http.server 8080 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          
          # ç­‰å¾…åŽç«¯å¯åŠ¨
          sleep 2

      - name: Run load tests
        run: |
          echo "=== è´Ÿè½½æµ‹è¯•å¼€å§‹ ==="
          
          # åŸºç¡€è¿žæŽ¥æµ‹è¯•
          if nc -z 127.0.0.1 3000; then
            echo "âœ… TCP forwarderæ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ TCP forwarderæœªå¯åŠ¨"
            exit 1
          fi
          
          # HTTPè´Ÿè½½æµ‹è¯•
          echo "è¿è¡ŒHTTPè´Ÿè½½æµ‹è¯•..."
          ab -n 1000 -c 10 http://127.0.0.1:3000/ || echo "è´Ÿè½½æµ‹è¯•å®Œæˆ"
          
          # ä½¿ç”¨wrkè¿›è¡Œæ›´è¯¦ç»†çš„æµ‹è¯•
          if command -v wrk &> /dev/null; then
            echo "è¿è¡Œwrkè´Ÿè½½æµ‹è¯•..."
            wrk -t4 -c10 -d30s http://127.0.0.1:3000/ || echo "wrkæµ‹è¯•å®Œæˆ"
          fi

      - name: Collect metrics
        run: |
          echo "=== æ”¶é›†æ€§èƒ½æŒ‡æ ‡ ==="
          
          # æ£€æŸ¥PrometheusæŒ‡æ ‡
          if curl -s http://127.0.0.1:9090/metrics > metrics.txt; then
            echo "âœ… æˆåŠŸæ”¶é›†PrometheusæŒ‡æ ‡"
            grep -E "(tcp_forwarder|connections|requests)" metrics.txt || echo "æŒ‡æ ‡æ”¶é›†å®Œæˆ"
          else
            echo "âŒ æ— æ³•æ”¶é›†PrometheusæŒ‡æ ‡"
          fi

      - name: Cleanup
        if: always()
        run: |
          # æ¸…ç†è¿›ç¨‹
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi
          if [ ! -z "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install profiling tools
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind heaptrack

      - name: Build with debug symbols
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Memory leak detection
        run: |
          cd tcp-forwarder
          echo "=== å†…å­˜æ³„æ¼æ£€æµ‹ ==="
          
          # ä½¿ç”¨valgrindæ£€æµ‹å†…å­˜æ³„æ¼
          timeout 30s valgrind \
            --tool=memcheck \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --verbose \
            ./target/release/tcp-forwarder --help || echo "å†…å­˜æ£€æµ‹å®Œæˆ"

  security-benchmark:
    name: Security Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Network security testing
        run: |
          echo "=== ç½‘ç»œå®‰å…¨æµ‹è¯• ==="
          
          # å®‰è£…ç½‘ç»œå®‰å…¨æµ‹è¯•å·¥å…·
          sudo apt-get update
          sudo apt-get install -y nmap netcat-openbsd
          
          cd tcp-forwarder
          
          # å¯åŠ¨åº”ç”¨è¿›è¡Œå®‰å…¨æµ‹è¯•
          cat > security_test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: false
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3001"
          EOF
          
          # å¯åŠ¨åº”ç”¨
          ./target/release/tcp-forwarder --config security_test_config.yaml &
          APP_PID=$!
          
          # ç­‰å¾…å¯åŠ¨
          sleep 3
          
          # ç«¯å£æ‰«ææµ‹è¯•
          if command -v nmap &> /dev/null; then
            echo "è¿è¡Œç«¯å£æ‰«æ..."
            nmap -p 3001 127.0.0.1 || echo "ç«¯å£æ‰«æå®Œæˆ"
          fi
          
          # è¿žæŽ¥æµ‹è¯•
          echo "è¿è¡Œè¿žæŽ¥æµ‹è¯•..."
          nc -z 127.0.0.1 3001 && echo "âœ… ç«¯å£å¯è®¿é—®" || echo "âŒ ç«¯å£ä¸å¯è®¿é—®"
          
          # æ¸…ç†
          kill $APP_PID || true

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [benchmark, load-test, memory-profiling]
    if: always()
    steps:
      - name: Generate performance report
        run: |
          echo "=== æ€§èƒ½æµ‹è¯•æŠ¥å‘Š ==="
          echo "åŸºå‡†æµ‹è¯•çŠ¶æ€: ${{ needs.benchmark.result }}"
          echo "è´Ÿè½½æµ‹è¯•çŠ¶æ€: ${{ needs.load-test.result }}"
          echo "å†…å­˜åˆ†æžçŠ¶æ€: ${{ needs.memory-profiling.result }}"
          
          # åˆ›å»ºæ€§èƒ½æŠ¥å‘Š
          cat > performance_report.md << 'EOF'
          # ðŸš€ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
          
          ## ðŸ“Š æµ‹è¯•ç»“æžœæ¦‚è§ˆ
          
          | æµ‹è¯•ç±»åž‹ | çŠ¶æ€ | è¯´æ˜Ž |
          |---------|------|------|
          | åŸºå‡†æµ‹è¯• | ${{ needs.benchmark.result }} | ä»£ç æ€§èƒ½åŸºå‡†æµ‹è¯• |
          | è´Ÿè½½æµ‹è¯• | ${{ needs.load-test.result }} | é«˜å¹¶å‘è´Ÿè½½æµ‹è¯• |
          | å†…å­˜åˆ†æž | ${{ needs.memory-profiling.result }} | å†…å­˜ä½¿ç”¨å’Œæ³„æ¼æ£€æµ‹ |
          
          ## ðŸ” è¯¦ç»†åˆ†æž
          
          ### æ€§èƒ½æŒ‡æ ‡
          - **ç¼–è¯‘æ—¶é—´**: å¾…æµ‹é‡
          - **äºŒè¿›åˆ¶å¤§å°**: å¾…æµ‹é‡
          - **å†…å­˜ä½¿ç”¨**: å¾…æµ‹é‡
          - **å¹¶å‘æ€§èƒ½**: å¾…æµ‹é‡
          
          ### ä¼˜åŒ–å»ºè®®
          - æ ¹æ®æµ‹è¯•ç»“æžœæä¾›å…·ä½“çš„ä¼˜åŒ–å»ºè®®
          - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œæ”¹è¿›ç‚¹
          
          ---
          æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)
          EOF
          
          echo "æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ"

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance_report.md
