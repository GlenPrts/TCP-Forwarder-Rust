name: Performance Monitoring

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # 每天 UTC 06:00 运行性能监控
    - cron: '0 6 * * *'

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Run unit test benchmarks
        run: |
          cd tcp-forwarder
          # 运行基准测试（如果存在）
          cargo test --release --tests -- --nocapture

      - name: Memory usage analysis
        run: |
          cd tcp-forwarder
          # 编译用于内存分析的版本
          cargo build --release
          
          # 使用valgrind进行内存分析（如果可用）
          if command -v valgrind &> /dev/null; then
            echo "Running memory analysis..."
            # valgrind --tool=massif --detailed-freq=1 --max-snapshots=100 ./target/release/tcp-forwarder --help
          fi

      - name: Binary size analysis
        run: |
          cd tcp-forwarder
          cargo build --release
          
          echo "=== 二进制文件大小分析 ==="
          ls -lh target/release/tcp-forwarder
          
          # 使用strip减小二进制大小
          strip target/release/tcp-forwarder
          echo "After strip:"
          ls -lh target/release/tcp-forwarder
          
          # 分析二进制文件组成
          if command -v bloaty &> /dev/null; then
            bloaty target/release/tcp-forwarder
          fi

  load-test:
    name: Load Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build application
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Setup test environment
        run: |
          # 安装负载测试工具
          sudo apt-get update
          sudo apt-get install -y wrk apache2-utils

      - name: Start TCP forwarder
        run: |
          cd tcp-forwarder
          # 创建测试配置
          cat > test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: true
              health_check_interval: 10s
              max_retries: 3
              weight: 1.0
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3000"
            
          metrics:
            enabled: true
            bind: "127.0.0.1:9090"
            
          scoring:
            algorithm: "ewma"
            ewma:
              alpha: 0.1
              max_score: 1000.0
              min_score: 1.0
              window_size: 10
          EOF
          
          # 启动应用程序（后台运行）
          ./target/release/tcp-forwarder --config test_config.yaml &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # 等待应用启动
          sleep 5

      - name: Setup mock backend
        run: |
          # 创建简单的HTTP服务器作为后端
          python3 -m http.server 8080 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          
          # 等待后端启动
          sleep 2

      - name: Run load tests
        run: |
          echo "=== 负载测试开始 ==="
          
          # 基础连接测试
          if nc -z 127.0.0.1 3000; then
            echo "✅ TCP forwarder正在运行"
          else
            echo "❌ TCP forwarder未启动"
            exit 1
          fi
          
          # HTTP负载测试
          echo "运行HTTP负载测试..."
          ab -n 1000 -c 10 http://127.0.0.1:3000/ || echo "负载测试完成"
          
          # 使用wrk进行更详细的测试
          if command -v wrk &> /dev/null; then
            echo "运行wrk负载测试..."
            wrk -t4 -c10 -d30s http://127.0.0.1:3000/ || echo "wrk测试完成"
          fi

      - name: Collect metrics
        run: |
          echo "=== 收集性能指标 ==="
          
          # 检查Prometheus指标
          if curl -s http://127.0.0.1:9090/metrics > metrics.txt; then
            echo "✅ 成功收集Prometheus指标"
            grep -E "(tcp_forwarder|connections|requests)" metrics.txt || echo "指标收集完成"
          else
            echo "❌ 无法收集Prometheus指标"
          fi

      - name: Cleanup
        if: always()
        run: |
          # 清理进程
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi
          if [ ! -z "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install profiling tools
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind heaptrack

      - name: Build with debug symbols
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Memory leak detection
        run: |
          cd tcp-forwarder
          echo "=== 内存泄漏检测 ==="
          
          # 使用valgrind检测内存泄漏
          timeout 30s valgrind \
            --tool=memcheck \
            --leak-check=full \
            --show-leak-kinds=all \
            --track-origins=yes \
            --verbose \
            ./target/release/tcp-forwarder --help || echo "内存检测完成"

  security-benchmark:
    name: Security Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build application
        run: |
          cd tcp-forwarder
          cargo build --release

      - name: Network security testing
        run: |
          echo "=== 网络安全测试 ==="
          
          # 安装网络安全测试工具
          sudo apt-get update
          sudo apt-get install -y nmap netcat-openbsd
          
          cd tcp-forwarder
          
          # 启动应用进行安全测试
          cat > security_test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: false
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3001"
          EOF
          
          # 启动应用
          ./target/release/tcp-forwarder --config security_test_config.yaml &
          APP_PID=$!
          
          # 等待启动
          sleep 3
          
          # 端口扫描测试
          if command -v nmap &> /dev/null; then
            echo "运行端口扫描..."
            nmap -p 3001 127.0.0.1 || echo "端口扫描完成"
          fi
          
          # 连接测试
          echo "运行连接测试..."
          nc -z 127.0.0.1 3001 && echo "✅ 端口可访问" || echo "❌ 端口不可访问"
          
          # 清理
          kill $APP_PID || true

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [benchmark, load-test, memory-profiling]
    if: always()
    steps:
      - name: Generate performance report
        run: |
          echo "=== 性能测试报告 ==="
          echo "基准测试状态: ${{ needs.benchmark.result }}"
          echo "负载测试状态: ${{ needs.load-test.result }}"
          echo "内存分析状态: ${{ needs.memory-profiling.result }}"
          
          # 创建性能报告
          cat > performance_report.md << 'EOF'
          # 🚀 性能测试报告
          
          ## 📊 测试结果概览
          
          | 测试类型 | 状态 | 说明 |
          |---------|------|------|
          | 基准测试 | ${{ needs.benchmark.result }} | 代码性能基准测试 |
          | 负载测试 | ${{ needs.load-test.result }} | 高并发负载测试 |
          | 内存分析 | ${{ needs.memory-profiling.result }} | 内存使用和泄漏检测 |
          
          ## 🔍 详细分析
          
          ### 性能指标
          - **编译时间**: 待测量
          - **二进制大小**: 待测量
          - **内存使用**: 待测量
          - **并发性能**: 待测量
          
          ### 优化建议
          - 根据测试结果提供具体的优化建议
          - 识别性能瓶颈和改进点
          
          ---
          报告生成时间: $(date)
          EOF
          
          echo "性能报告已生成"

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance_report.md
