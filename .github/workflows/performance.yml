# Performance Monitoring
#
# æœ¬å·¥ä½œæµè‡ªåŠ¨åŒ–æ€§èƒ½ç›‘æŽ§ã€åŸºå‡†æµ‹è¯•ã€è´Ÿè½½æµ‹è¯•ã€å†…å­˜åˆ†æžã€å®‰å…¨åŸºå‡†æµ‹è¯•ï¼Œå¹¶ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šã€‚
# æ”¯æŒä¸»åˆ†æ”¯ã€PRã€æ‰‹åŠ¨è§¦å‘å’Œå®šæ—¶è§¦å‘ï¼ˆå¯è§£æ³¨é‡Š scheduleï¼‰ã€‚

name: Performance Monitoring

on:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  # schedule:
  #   - cron: '0 6 * * *' # æ¯å¤© UTC 06:00 è¿è¡Œæ€§èƒ½ç›‘æŽ§
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # 1. æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ç¼“å­˜ Cargo ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tcp-forwarder/target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: è¿è¡Œå•å…ƒæµ‹è¯•åŸºå‡†
        run: |
          cd tcp-forwarder
          # è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼ˆå¦‚æœ‰ï¼‰
          cargo test --release --tests -- --nocapture

      - name: å†…å­˜ä½¿ç”¨åˆ†æž
        run: |
          cd tcp-forwarder
          cargo build --release
          if command -v valgrind &> /dev/null; then
            echo "Running memory analysis..."
            # valgrind --tool=massif --detailed-freq=1 --max-snapshots=100 ./target/release/tcp-forwarder --help
          fi

      - name: äºŒè¿›åˆ¶å¤§å°åˆ†æž
        run: |
          cd tcp-forwarder
          cargo build --release
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°åˆ†æž ==="
          ls -lh target/release/tcp-forwarder
          strip target/release/tcp-forwarder
          echo "After strip:"
          ls -lh target/release/tcp-forwarder
          if command -v bloaty &> /dev/null; then
            bloaty target/release/tcp-forwarder
          fi

  # 2. è´Ÿè½½æµ‹è¯•
  load-test:
    name: è´Ÿè½½æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: æž„å»ºåº”ç”¨
        run: cd tcp-forwarder && cargo build --release

      - name: å®‰è£…è´Ÿè½½æµ‹è¯•å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y wrk apache2-utils

      - name: å¯åŠ¨ TCP forwarder
        run: |
          cd tcp-forwarder
          # åˆ›å»ºæµ‹è¯•é…ç½®
          cat > test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: true
              health_check_interval: 10s
              max_retries: 3
              weight: 1.0
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3000"
            
          metrics:
            enabled: true
            bind: "127.0.0.1:9090"
            
          scoring:
            algorithm: "ewma"
            ewma:
              alpha: 0.1
              max_score: 1000.0
              min_score: 1.0
              window_size: 10
          EOF
          ./target/release/tcp-forwarder --config test_config.yaml &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          sleep 5

      - name: å¯åŠ¨æ¨¡æ‹ŸåŽç«¯
        run: |
          python3 -m http.server 8080 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          sleep 2

      - name: è¿è¡Œè´Ÿè½½æµ‹è¯•
        run: |
          echo "=== è´Ÿè½½æµ‹è¯•å¼€å§‹ ==="
          if nc -z 127.0.0.1 3000; then
            echo "âœ… TCP forwarderæ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ TCP forwarderæœªå¯åŠ¨"
            exit 1
          fi
          ab -n 1000 -c 10 http://127.0.0.1:3000/ || echo "è´Ÿè½½æµ‹è¯•å®Œæˆ"
          if command -v wrk &> /dev/null; then
            wrk -t4 -c10 -d30s http://127.0.0.1:3000/ || echo "wrkæµ‹è¯•å®Œæˆ"
          fi

      - name: æ”¶é›†æ€§èƒ½æŒ‡æ ‡
        run: |
          if curl -s http://127.0.0.1:9090/metrics > metrics.txt; then
            echo "âœ… æˆåŠŸæ”¶é›†PrometheusæŒ‡æ ‡"
            grep -E "(tcp_forwarder|connections|requests)" metrics.txt || echo "æŒ‡æ ‡æ”¶é›†å®Œæˆ"
          else
            echo "âŒ æ— æ³•æ”¶é›†PrometheusæŒ‡æ ‡"
          fi

      - name: æ¸…ç†è¿›ç¨‹
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then kill $APP_PID || true; fi
          if [ ! -z "$BACKEND_PID" ]; then kill $BACKEND_PID || true; fi

  # 3. å†…å­˜åˆ†æž
  memory-profiling:
    name: å†…å­˜åˆ†æž
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…åˆ†æžå·¥å…·
        run: sudo apt-get update && sudo apt-get install -y valgrind heaptrack

      - name: æž„å»ºå¸¦è°ƒè¯•ç¬¦å·çš„ç‰ˆæœ¬
        run: cd tcp-forwarder && cargo build --release

      - name: å†…å­˜æ³„æ¼æ£€æµ‹
        run: |
          cd tcp-forwarder
          echo "=== å†…å­˜æ³„æ¼æ£€æµ‹ ==="
          timeout 30s valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all --track-origins=yes --verbose ./target/release/tcp-forwarder --help || echo "å†…å­˜æ£€æµ‹å®Œæˆ"

  # 4. å®‰å…¨åŸºå‡†æµ‹è¯•
  security-benchmark:
    name: å®‰å…¨åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æž„å»ºåº”ç”¨
        run: cd tcp-forwarder && cargo build --release

      - name: ç½‘ç»œå®‰å…¨æµ‹è¯•
        run: |
          sudo apt-get update && sudo apt-get install -y nmap netcat-openbsd
          cd tcp-forwarder
          cat > security_test_config.yaml << 'EOF'
          proxy:
            dial_timeout: 5s
            idle_timeout: 30s
            
          pools:
            default:
              health_check: false
              endpoints:
                - "127.0.0.1:8080"
          
          server:
            bind: "127.0.0.1:3001"
          EOF
          ./target/release/tcp-forwarder --config security_test_config.yaml &
          APP_PID=$!
          sleep 3
          if command -v nmap &> /dev/null; then
            nmap -p 3001 127.0.0.1 || echo "ç«¯å£æ‰«æå®Œæˆ"
          fi
          nc -z 127.0.0.1 3001 && echo "âœ… ç«¯å£å¯è®¿é—®" || echo "âŒ ç«¯å£ä¸å¯è®¿é—®"
          kill $APP_PID || true

  # 5. æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ
  performance-report:
    name: æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [benchmark, load-test, memory-profiling]
    if: always()
    steps:
      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: |
          echo "=== æ€§èƒ½æµ‹è¯•æŠ¥å‘Š ==="
          echo "åŸºå‡†æµ‹è¯•çŠ¶æ€: ${{ needs.benchmark.result }}"
          echo "è´Ÿè½½æµ‹è¯•çŠ¶æ€: ${{ needs.load-test.result }}"
          echo "å†…å­˜åˆ†æžçŠ¶æ€: ${{ needs.memory-profiling.result }}"
          cat > performance_report.md << 'EOF'
          # ðŸš€ æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
          
          ## ðŸ“Š æµ‹è¯•ç»“æžœæ¦‚è§ˆ
          
          | æµ‹è¯•ç±»åž‹ | çŠ¶æ€ | è¯´æ˜Ž |
          |---------|------|------|
          | åŸºå‡†æµ‹è¯• | ${{ needs.benchmark.result }} | ä»£ç æ€§èƒ½åŸºå‡†æµ‹è¯• |
          | è´Ÿè½½æµ‹è¯• | ${{ needs.load-test.result }} | é«˜å¹¶å‘è´Ÿè½½æµ‹è¯• |
          | å†…å­˜åˆ†æž | ${{ needs.memory-profiling.result }} | å†…å­˜ä½¿ç”¨å’Œæ³„æ¼æ£€æµ‹ |
          
          ## ðŸ” è¯¦ç»†åˆ†æž
          
          ### æ€§èƒ½æŒ‡æ ‡
          - **ç¼–è¯‘æ—¶é—´**: å¾…æµ‹é‡
          - **äºŒè¿›åˆ¶å¤§å°**: å¾…æµ‹é‡
          - **å†…å­˜ä½¿ç”¨**: å¾…æµ‹é‡
          - **å¹¶å‘æ€§èƒ½**: å¾…æµ‹é‡
          
          ### ä¼˜åŒ–å»ºè®®
          - æ ¹æ®æµ‹è¯•ç»“æžœæä¾›å…·ä½“çš„ä¼˜åŒ–å»ºè®®
          - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œæ”¹è¿›ç‚¹
          
          ---
          æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)
          EOF
          echo "æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ"

      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance_report.md
